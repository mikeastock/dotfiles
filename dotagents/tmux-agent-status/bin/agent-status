#!/usr/bin/env bash
#
# agent-status - Display agent states for tmux status bar (multi-agent support)
#
# Output format: session ◉●  session2 ○
#   ◉ = waiting for user input (yellow)
#   ● = working (green)
#   ○ = idle (dim)
#
# State file structure (keyed by PID):
# {
#   "agents": {
#     "12345": { "session": "dev", "pane": "%1", "agent": "pi", "state": "working" },
#     "67890": { "session": "dev", "pane": "%3", "agent": "codex", "state": "waiting" }
#   }
# }
#

STATE_FILE="$HOME/.config/agents/state.json"

# Exit silently if no state file or jq unavailable
[[ -f "$STATE_FILE" ]] || exit 0
command -v jq &>/dev/null || exit 0

# Check if a PID is running
is_running() {
  kill -0 "$1" 2>/dev/null
}

# Build list of live PIDs and collect stale ones
live_pids=""
stale_pids=""

for pid in $(jq -r '.agents // {} | keys[]' "$STATE_FILE" 2>/dev/null); do
  if is_running "$pid"; then
    live_pids+="\"$pid\","
  else
    stale_pids+="$pid "
  fi
done

# Remove trailing comma
live_pids="${live_pids%,}"

# If no live agents, clean up and exit
if [[ -z "$live_pids" ]]; then
  # Clean up all stale PIDs
  if [[ -n "$stale_pids" ]]; then
    (
      for pid in $stale_pids; do
        tmp=$(mktemp)
        jq "del(.agents[\"$pid\"])" "$STATE_FILE" > "$tmp" 2>/dev/null && mv "$tmp" "$STATE_FILE"
      done
    ) &
  fi
  exit 0
fi

# Use jq to:
# 1. Filter to only live PIDs
# 2. Group by session
# 3. Output session + states in a parseable format
output=$(jq -r --argjson live "[$live_pids]" '
  .agents
  | to_entries
  | map(select(.key as $k | $live | index($k)))
  | group_by(.value.session)
  | map({
      session: .[0].value.session,
      has_waiting: (map(.value.state) | index("waiting") != null),
      has_working: (map(.value.state) | index("working") != null),
      has_idle: (map(.value.state) | index("idle") != null)
    })
  | sort_by(.session)
  | .[]
  | [.session, .has_waiting, .has_working, .has_idle]
  | @tsv
' "$STATE_FILE" 2>/dev/null)

# Build tmux-formatted output
result=""
while IFS=$'\t' read -r session has_waiting has_working has_idle; do
  [[ -z "$session" ]] && continue
  
  indicators=""
  [[ "$has_waiting" == "true" ]] && indicators+="#[fg=yellow]◉"
  [[ "$has_working" == "true" ]] && indicators+="#[fg=green]●"
  [[ "$has_idle" == "true" ]] && indicators+="#[fg=colour244]○"
  
  if [[ -n "$indicators" ]]; then
    result+="${session} ${indicators}#[fg=default]  "
  fi
done <<< "$output"

# Clean up stale PIDs (async, don't block status bar)
if [[ -n "$stale_pids" ]]; then
  (
    for pid in $stale_pids; do
      tmp=$(mktemp)
      jq "del(.agents[\"$pid\"])" "$STATE_FILE" > "$tmp" 2>/dev/null && mv "$tmp" "$STATE_FILE"
    done
  ) &
fi

# Output (trim trailing spaces)
echo -n "${result%  }"
