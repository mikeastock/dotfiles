#!/usr/bin/env bash
#
# agent-status - Display agent states for tmux status bar
#
# Output format: session ◉  session ●  session ○
#   ◉ = waiting for user input (yellow)
#   ● = working (green)
#   ○ = idle (dim) - pi only, codex doesn't report idle
#
# Agents:
#   pi    - full lifecycle (idle, working, waiting)
#   codex - waiting-only (only shows when needs attention)
#

STATE_FILE="$HOME/.config/agents/state.json"

# Exit silently if no state file
[[ -f "$STATE_FILE" ]] || exit 0

# Check if a PID is running
is_running() {
  kill -0 "$1" 2>/dev/null
}

# Read state file and output tmux-formatted status
output=""
stale_sessions=()

# Parse JSON with jq (fall back to empty if jq not available)
if ! command -v jq &>/dev/null; then
  exit 0
fi

# Get all sessions from state file
sessions=$(jq -r '.sessions | keys[]' "$STATE_FILE" 2>/dev/null)

for session in $sessions; do
  state=$(jq -r ".sessions[\"$session\"].state" "$STATE_FILE" 2>/dev/null)
  pid=$(jq -r ".sessions[\"$session\"].pid" "$STATE_FILE" 2>/dev/null)
  agent=$(jq -r ".sessions[\"$session\"].agent // \"unknown\"" "$STATE_FILE" 2>/dev/null)
  
  # Check if process is still running
  if ! is_running "$pid"; then
    stale_sessions+=("$session")
    continue
  fi
  
  # Format based on state
  case "$state" in
    waiting)
      output+="#[fg=yellow]${session} ◉#[fg=default] "
      ;;
    working)
      output+="#[fg=green]${session} ●#[fg=default] "
      ;;
    idle)
      # Only show idle for agents that report it (pi)
      # Codex only reports "waiting", so if we see idle it's from pi
      output+="#[fg=colour244]${session} ○#[fg=default] "
      ;;
  esac
done

# Clean up stale sessions (async, don't block status bar)
if [[ ${#stale_sessions[@]} -gt 0 ]]; then
  (
    for session in "${stale_sessions[@]}"; do
      # Read current state, remove stale session, write back
      tmp=$(mktemp)
      jq "del(.sessions[\"$session\"])" "$STATE_FILE" > "$tmp" 2>/dev/null && mv "$tmp" "$STATE_FILE"
    done
  ) &
fi

# Output (trim trailing space)
echo -n "${output% }"
